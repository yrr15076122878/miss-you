<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
    <title>忘记了密码？</title>
    <link rel="stylesheet" href="plugin/bootstrap/css/_bootstrap.css">
    <link rel="stylesheet" href="plugin/layui/css/layui.css">
    <link rel="stylesheet" href="Application/Default/Css/register.css">

</head>
<body>
<br>
<br>
<form id="form_fp">
    <div class="col-md-12">
        <div class="col-md-12" style="border:1px solid #b5b8c8;padding-bottom: 15px;">
            <span class="infoSpan">基本信息</span>
            <br>
            <table class="basicInfo" border="0">
                <tr>
                    <td class="text-right" width="25%"><label for="UserName">用户名<span class="redText">*</span>：</label></td>
                    <td colspan="3">
                        <input type="text" name="UserName" id="UserName" class="width" required data-reg="/^[a-zA-Z0-9_-]{6,12}$/">
                    </td>
                </tr>
                <tr>
                    <td class="text-right" width="25%"><label for="Email">联系人邮箱<span class="redText">*</span>：</label></td>
                    <td colspan="3">
                        <input type="text" name="Email" id="Email" class="width" required data-reg="/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/" style="padding-right: 110px;">
                        <button class="authCode">获取验证码</button>
                    </td>
                </tr>
                <tr>
                    <td class="text-right" width="25%"><label for="authCode">验证码<span class="redText">*</span>：</label></td>
                    <td colspan="3">
                        <input type="text" name="authCode" id="authCode" class="width" required data-reg="/^[\w\W]{1,}$/">

                    </td>
                </tr>
                <tr>
                    <td class="text-right" width="25%"><label for="newPass">新密码<span class="redText">*</span>：</label></td>
                    <td colspan="3"><input type="password" name="newPass" id="newPass" class="width" required data-reg="/^[\w\W]{4,}$/"></td>
                </tr>
                <tr>
                    <td class="text-right" width="25%"><label for="cnewPass">确认密码<span class="redText">*</span>：</label></td>
                    <td colspan="3"><input type="password" name="cnewPass" id="cnewPass" class="width" required></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="col-md-12 clearfix okAndCan">
        <div class="clearfix" style="width:268px;margin: 0 auto;">
            <button id="ok">提交</button>
            <button id="cancel">取消</button>
        </div>
    </div>
</form>

<script type="text/javascript" src="Public/Js/jquery-1.9.1.min.js"></script>
<script src="plugin/layui/layui.all.js"></script>
<script>
    $(function(){
        //获取验证码
        $(".authCode").click(function(e){
            e.preventDefault();
            var UserName = $("#UserName").val();
            var Email = $("#Email").val();
            var msg = [];
            if(!UserName){
                msg.push("请输入 <span style='color:red'>用户名</span>！");
            }else{
                var reg = $("#UserName").attr("data-reg");
                if(reg){
                    var e = eval(reg);
                    if(!e.test(UserName)){
                        msg.push("请填写一个有效的 <span style='color:red'>用户名</span>！");
                    }
                }
            }
            if(!Email){
                msg.push("请输入 <span style='color:red'>联系人邮箱</span>！");
            }else{
                var reg = $("#Email").attr("data-reg");
                if(reg){
                    var e = eval(reg);
                    if(!e.test(Email)){
                        msg.push("请填写一个有效的 <span style='color:red'>邮箱</span>！");
                    }
                }
            }
            if(msg.length>0){
                parent.layer.alert(msg.join("<br/>")+"<br/> <span style='font-size: 12px;'>（请注意：此处的用户名和邮箱需要和注册时一致）</span>");
                return;
            }

            $.ajax({
                url:"/getAuthCode/",
                data:{"UserName":UserName},
                type:"post",
                dataType:"json",
                cache:false,
                timeout:10000,
                async:true,
                success:function(data){
                    if(data===0){
                        parent.layer.alert('用户名不存在或与注册的邮箱不符！', {icon: 2});
                    }else{
                        layer.msg("验证码已发出，请注意查看邮箱！",{time: 5000});
                        var num = 60;
                        $(".authCode").prop("disabled",true).addClass("grayBg");
                        var js = setInterval(function(){
                            $(".authCode").text(num--+" s");
                            if(num===0){
                                clearInterval(js);
                                $(".authCode").removeAttr("disabled").removeClass("grayBg").text("获取验证码");
                            }
                        },1000);

                    }
                },
                error:function(e){
                    parent.layer.alert('获取验证码出错了！', {icon: 2});
                }
            });
        });

        //提交
        $("#ok").click(function(event){
            event.preventDefault();
            checkForm();
            var flag = $("#form_fp input").hasClass("errorInp");
            if(!flag){ //校验通过
                var indexOk = layer.confirm('确认无误后再提交', {title:"提交确认",
                    btn: ['确认','再看看'] //按钮
                }, function(){
                    layer.close(indexOk);
                    $.ajax({
                        url:"/update/",
                        data:$("#form_fp").serialize(),
                        type:"post",
                        dataType:"json",
                        cache:false,
                        timeout:20000,
                        async:false,
                        success:function(data){
                            if(data===-1){
                                parent.layer.alert('验证码错误！', {icon: 2});
                            }else if(data===1){
                                //确认完成后关闭窗口
                                var pindex = parent.layer.getFrameIndex(window.name); //获取窗口索引
                                parent.layer.close(pindex);//关闭窗口
                                parent.layer.msg("表单信息已提交！");
                            }else{
                                parent.layer.alert('未知错误！', {icon: 2});
                            }

                        },
                        error:function(e){
                            parent.layer.alert('重置密码出错了！', {icon: 2});
                        }
                    });

                },function(){

                });
            }else{
                parent.layer.alert("请检查表单红色信息！<br/> <span class='redText'>*</span> 标注的为必填项。",{icon: 2, title:'错误提示'});
            }
        });

        //关闭弹框
        $("#cancel").click(function(e){
            e.preventDefault();
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);//关闭窗口
        });
        //输入框输入
        $("#form_fp input").on("input blur",function(){
            valide(this);
        });
        //tip 层
        var index = "";
        $("#form_fp input").on("mouseover",function(){
            var id = $(this).attr("id");
            var errorMsg = $(this).attr("errorMsg");
            if(errorMsg){
                index = layer.tips(errorMsg, "#"+id,{tips: [1,'#0f74cc']});
            }
        });
        $("#form_fp input").on("mouseout",function () {
            if(index){
                layer.close(index);
                index = "";
            }
        });
    });

    function checkForm(){
        $("#form_fp input").each(function(index,$this){
            valide(this);
        });
    }
    //一个简单的校验
    function valide($this) {
        if (!$this) {
            return;
        }
        var _this = $($this);
        var id = _this.attr("id");
        var val = $.trim(_this.val());
        var reg = _this.attr("data-reg");
        var e;
        if (reg) {
            e = eval(reg);
        }
        if(id==="UserName"){
            if(val){
                if(!e.test(val)){
                    _this.attr("errorMsg","用户名为 6 到 12 位（字母，数字，_，-）！").addClass("errorInp");
                }else{
                    _this.removeAttr("errorMsg").removeClass("errorInp");
                }
            }else{
                _this.attr("errorMsg","用户名为必填项！").addClass("errorInp");
            }
        } else if(id==="Email"){
            if(val){
                if(!e.test(val)){
                    _this.attr("errorMsg","请输入有效的邮箱！").addClass("errorInp");
                }else{
                    _this.removeAttr("errorMsg").removeClass("errorInp");
                }
            }else{
                _this.attr("errorMsg","联系人邮箱为必填项！").addClass("errorInp");
            }
        }else if(id==="authCode"){
            if(val){
                if(!e.test(val)){
                    _this.attr("errorMsg","请输入验证码！").addClass("errorInp");
                }else{
                    _this.removeAttr("errorMsg").removeClass("errorInp");
                }
            }else{
                _this.attr("errorMsg","验证码为必填项！").addClass("errorInp");
            }
        }else if(id==="newPass"){
            if(val){
                if(!e.test(val)){
                    _this.attr("errorMsg","密码最小为4位！").addClass("errorInp");
                }else{
                    _this.removeAttr("errorMsg").removeClass("errorInp");
                }
            }else{
                _this.attr("errorMsg","密码为必填项！").addClass("errorInp");
            }
        }else if(id==="cnewPass"){
            var password = $("#newPass").val();
            if(password!==val){
                _this.attr("errorMsg","两次密码输入不一致！").addClass("errorInp");
            }else{
                _this.removeAttr("errorMsg").removeClass("errorInp");
            }
        }else{

        }
    }
</script>
</body>
</html>